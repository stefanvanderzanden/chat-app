{% extends "base.html" %}

{% block title %}Room: {{ room.name }}{% endblock %}

{% block content %}
<h2>Room: {{ room.name }}</h2>

<div id="chat-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
    <ul id="chat-log">
        <!-- Berichten komen hier -->
    </ul>
</div>

<form id="chat-form" action="javascript:void(0);">
    {% csrf_token %}
    <input id="chat-message-input" type="text" size="80" placeholder="Typ je bericht..." autocomplete="off">
    <button type="submit">Verstuur</button>
</form>

<button id="load-more">Meer laden</button>
{% endblock %}

{% block extra_js %}
<script>
    const roomId = {{ room.id }};
    const roomName = "{{ room.name|escapejs }}";
    const chatLog = document.querySelector("#chat-log");
    const chatForm = document.querySelector("#chat-form");
    const messageInput = document.querySelector("#chat-message-input");
    const loadMoreBtn = document.querySelector("#load-more");

    let nextPageUrl = `/api/chat/rooms/${roomId}/messages/?page=1`;

    // ðŸ”¹ Berichten renderen
    function renderMessage(msg) {
        const li = document.createElement("li");
        li.textContent = `[${new Date(msg.created_at).toLocaleTimeString()}] ${msg.user}: ${msg.text}`;
        chatLog.appendChild(li);
    }

    // ðŸ”¹ Init: eerste berichten laden
    async function loadMessages(initial=false) {
        if (!nextPageUrl) return;

        const response = await fetch(nextPageUrl);
        const data = await response.json();

        // Bij paginatie gebruikt DRF "results"
        const results = data.results || data;

        // Zet de berichten vooraan (oudste eerst)
        results.reverse().forEach(renderMessage);

        nextPageUrl = data.next;  // volgende pagina
        if (!nextPageUrl) {
            loadMoreBtn.style.display = "none";
        }

        if (initial) {
            chatLog.scrollTop = chatLog.scrollHeight; // scrol naar beneden
        }
    }

    loadMessages(true);

    // ðŸ”¹ Meer laden knop
    loadMoreBtn.addEventListener("click", () => {
        loadMessages(false);
    });

    // ðŸ”¹ WebSocket connectie
    {#const protocol = window.location.protocol === "https:" ? "wss" : "ws";#}
    {#const chatSocket = new WebSocket(#}
    {#    `${protocol}://${window.location.host}/ws/chat/`#}
    {#);#}

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.message) {
            renderMessage({
                user: data.user,
                text: data.message,
                created_at: new Date().toISOString()
            });
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    };

    chatSocket.onclose = function(e) {
        console.error("Chat socket gesloten onverwachts");
    };

    // ðŸ”¹ Bericht versturen
    chatForm.addEventListener("submit", function(e) {

        console.log('inside submit')
        e.preventDefault();
        if (messageInput.value.trim() === "") return;

        chatSocket.send(JSON.stringify({
            message: messageInput.value
        }));

        messageInput.value = "";
    });
</script>
{% endblock %}
